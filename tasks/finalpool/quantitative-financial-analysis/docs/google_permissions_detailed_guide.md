# Google Drive API æƒé™é…ç½®æŒ‡å—

## æ¦‚è¿°

æœ¬æ–‡æ¡£è¯¦ç»†è®²è§£å¦‚ä½•é…ç½®å’Œé™åˆ¶Google Drive APIçš„æƒé™ï¼Œä»¥ç¡®ä¿ç³»ç»Ÿå®‰å…¨æ€§å’ŒåŠŸèƒ½éœ€æ±‚çš„å¹³è¡¡ã€‚

## å½“å‰æƒé™é…ç½®

### ç°æœ‰é…ç½®
```python
SCOPES = [
    'https://www.googleapis.com/auth/spreadsheets',  # Google Sheetså®Œæ•´è®¿é—®æƒé™
    'https://www.googleapis.com/auth/drive'          # Google Driveå®Œæ•´è®¿é—®æƒé™
]
```

### æƒé™è¯´æ˜
- `spreadsheets`: å®Œæ•´çš„Google Sheetsè¯»å†™æƒé™
- `drive`: å®Œæ•´çš„Google Driveè®¿é—®æƒé™ï¼ˆ**æœ€å®½æ³›çš„æƒé™**ï¼‰

## Google Drive APIæƒé™å±‚çº§

### æƒé™èŒƒå›´å±‚çº§å›¾
```
Google Drive API æƒé™å±‚çº§:

ğŸ“ drive (æœ€é«˜æƒé™)
â”œâ”€â”€ å¯è®¿é—®ç”¨æˆ·æ‰€æœ‰Driveæ–‡ä»¶
â”œâ”€â”€ å¯åˆ›å»ºã€è¯»å–ã€ä¿®æ”¹ã€åˆ é™¤ä»»ä½•æ–‡ä»¶
â””â”€â”€ å¯ç®¡ç†æ–‡ä»¶å¤¹å’Œå…±äº«è®¾ç½®

ğŸ“‚ drive.file (åº”ç”¨æ–‡ä»¶æƒé™)
â”œâ”€â”€ åªèƒ½è®¿é—®é€šè¿‡æ­¤åº”ç”¨åˆ›å»ºæˆ–æ‰“å¼€çš„æ–‡ä»¶
â”œâ”€â”€ æ— æ³•è®¿é—®å…¶ä»–åº”ç”¨åˆ›å»ºçš„æ–‡ä»¶
â””â”€â”€ å®‰å…¨æ€§è¾ƒé«˜ï¼Œæ¨èä½¿ç”¨

ğŸ“– drive.readonly (åªè¯»æƒé™)
â”œâ”€â”€ å¯è¯»å–ç”¨æˆ·æ‰€æœ‰Driveæ–‡ä»¶
â”œâ”€â”€ æ— æ³•ä¿®æ”¹æˆ–åˆ é™¤ä»»ä½•æ–‡ä»¶
â””â”€â”€ é€‚ç”¨äºåªéœ€è¦è¯»å–çš„åœºæ™¯

ğŸ“Š drive.metadata (å…ƒæ•°æ®æƒé™)
â”œâ”€â”€ å¯è¯»å–æ–‡ä»¶å…ƒæ•°æ®ï¼ˆåç§°ã€å¤§å°ã€åˆ›å»ºæ—¶é—´ç­‰ï¼‰
â”œâ”€â”€ æ— æ³•è®¿é—®æ–‡ä»¶å†…å®¹
â””â”€â”€ é€‚ç”¨äºæ–‡ä»¶ç®¡ç†å’Œæœç´¢

ğŸ” drive.metadata.readonly (åªè¯»å…ƒæ•°æ®)
â”œâ”€â”€ åªèƒ½è¯»å–æ–‡ä»¶å…ƒæ•°æ®
â”œâ”€â”€ æ— æ³•ä¿®æ”¹å…ƒæ•°æ®
â””â”€â”€ æœ€å°æƒé™ï¼Œé€‚ç”¨äºæ–‡ä»¶åˆ—è¡¨å±•ç¤º
```

## è¯¦ç»†æƒé™å¯¹ç…§è¡¨

| æƒé™èŒƒå›´ | è¯»å–æ–‡ä»¶ | åˆ›å»ºæ–‡ä»¶ | ä¿®æ”¹æ–‡ä»¶ | åˆ é™¤æ–‡ä»¶ | è®¿é—®èŒƒå›´ | å®‰å…¨çº§åˆ« |
|---------|---------|---------|---------|---------|---------|----------|
| `drive` | âœ… | âœ… | âœ… | âœ… | æ‰€æœ‰æ–‡ä»¶ | âš ï¸ ä½ |
| `drive.file` | âœ… | âœ… | âœ… | âœ… | åº”ç”¨æ–‡ä»¶ | âœ… ä¸­ |
| `drive.readonly` | âœ… | âŒ | âŒ | âŒ | æ‰€æœ‰æ–‡ä»¶ | âœ… ä¸­ |
| `drive.metadata` | ä»…å…ƒæ•°æ® | âŒ | ä»…å…ƒæ•°æ® | âŒ | æ‰€æœ‰æ–‡ä»¶ | âœ… é«˜ |
| `drive.metadata.readonly` | ä»…å…ƒæ•°æ® | âŒ | âŒ | âŒ | æ‰€æœ‰æ–‡ä»¶ | âœ… æœ€é«˜ |

## Google Sheetsæƒé™

| æƒé™èŒƒå›´ | è¯»å– | åˆ›å»º | ä¿®æ”¹ | åˆ é™¤ | æ ¼å¼åŒ– | å®‰å…¨çº§åˆ« |
|---------|------|------|------|------|--------|----------|
| `spreadsheets` | âœ… | âœ… | âœ… | âœ… | âœ… | âš ï¸ ä½ |
| `spreadsheets.readonly` | âœ… | âŒ | âŒ | âŒ | âŒ | âœ… é«˜ |

## æƒé™é…ç½®å»ºè®®

### 1. æŒ‰åŠŸèƒ½åˆ†ç¦»æƒé™

#### é¢„å¤„ç†è„šæœ¬ï¼ˆéœ€è¦åˆ é™¤æƒé™ï¼‰
```python
SCOPES = [
    'https://www.googleapis.com/auth/spreadsheets',     # Sheetså®Œæ•´è®¿é—®
    'https://www.googleapis.com/auth/drive.file'        # åªèƒ½æ“ä½œåº”ç”¨åˆ›å»ºçš„æ–‡ä»¶
]
```

#### Evaluationè„šæœ¬ï¼ˆåªéœ€è¯»å–ï¼‰
```python
SCOPES = [
    'https://www.googleapis.com/auth/spreadsheets.readonly',  # Sheetsåªè¯»
    'https://www.googleapis.com/auth/drive.readonly'          # Driveåªè¯»
]
```

#### å…ƒæ•°æ®æ£€æŸ¥è„šæœ¬ï¼ˆæœ€å°æƒé™ï¼‰
```python
SCOPES = [
    'https://www.googleapis.com/auth/drive.metadata.readonly'  # åªè¯»æ–‡ä»¶å…ƒæ•°æ®
]
```

### 2. ç¯å¢ƒåˆ†ç¦»

#### å¼€å‘ç¯å¢ƒï¼ˆè¾ƒå®½æƒé™ï¼‰
```python
SCOPES = [
    'https://www.googleapis.com/auth/spreadsheets',
    'https://www.googleapis.com/auth/drive'  # å¼€å‘æ—¶ä½¿ç”¨å®Œæ•´æƒé™
]
```

#### ç”Ÿäº§ç¯å¢ƒï¼ˆä¸¥æ ¼æƒé™ï¼‰
```python
SCOPES = [
    'https://www.googleapis.com/auth/spreadsheets.readonly',
    'https://www.googleapis.com/auth/drive.file'  # ç”Ÿäº§ç¯å¢ƒé™åˆ¶æƒé™
]
```

## å®é™…æƒé™é—®é¢˜åˆ†æ

### å½“å‰é‡åˆ°çš„é—®é¢˜

1. **æ–‡ä»¶æ‰€æœ‰æƒå†²çª**
   - æœåŠ¡è´¦å·Aåˆ›å»ºçš„æ–‡ä»¶ï¼ŒæœåŠ¡è´¦å·Bæ— æ³•åˆ é™¤
   - å³ä½¿æœ‰`drive`æƒé™ä¹Ÿæ— æ³•åˆ é™¤å…¶ä»–ç”¨æˆ·çš„æ–‡ä»¶

2. **è§£å†³æ–¹æ¡ˆ**
   ```python
   # æ–¹æ¡ˆ1: ä½¿ç”¨drive.fileæƒé™ï¼ˆåªèƒ½åˆ é™¤è‡ªå·±åˆ›å»ºçš„ï¼‰
   SCOPES = ['https://www.googleapis.com/auth/drive.file']
   
   # æ–¹æ¡ˆ2: æ–‡ä»¶å‘½ååŠ æ—¶é—´æˆ³é¿å…å†²çª
   filename = f"2025_Q2_Market_Data_{int(time.time())}"
   
   # æ–¹æ¡ˆ3: æ£€æŸ¥æ–‡ä»¶æ‰€æœ‰è€…å†å†³å®šæ“ä½œ
   def check_file_owner(service, file_id):
       file_metadata = service.files().get(fileId=file_id, fields='owners').execute()
       return file_metadata.get('owners', [])
   ```

## æƒé™ä¿®æ”¹æ­¥éª¤

### 1. ä¿®æ”¹preprocessè„šæœ¬æƒé™
```python
# æ–‡ä»¶: tasks/finalpool/quantitative-financial-analysis/preprocess/main.py
SCOPES = [
    'https://www.googleapis.com/auth/spreadsheets',     # ä¿æŒSheetså®Œæ•´è®¿é—®
    'https://www.googleapis.com/auth/drive.file'        # é™åˆ¶ä¸ºåº”ç”¨æ–‡ä»¶
]
```

### 2. ä¿®æ”¹evaluationè„šæœ¬æƒé™
```python
# æ–‡ä»¶: tasks/finalpool/quantitative-financial-analysis/evaluation/check_content.py
SCOPES = [
    'https://www.googleapis.com/auth/spreadsheets.readonly',  # åªè¯»Sheets
    'https://www.googleapis.com/auth/drive.readonly'          # åªè¯»Drive
]
```

### 3. é‡æ–°æˆæƒ
ä¿®æ”¹æƒé™åéœ€è¦ï¼š
1. åˆ é™¤ç°æœ‰çš„tokenæ–‡ä»¶
2. é‡æ–°è¿è¡Œæˆæƒæµç¨‹
3. ç”¨æˆ·é‡æ–°æˆæƒæ–°çš„æƒé™èŒƒå›´

## å®‰å…¨æœ€ä½³å®è·µ

### 1. æœ€å°æƒé™åŸåˆ™
- åªç”³è¯·å¿…éœ€çš„æƒé™
- å®šæœŸå®¡æŸ¥æƒé™ä½¿ç”¨æƒ…å†µ
- åŠæ—¶ç§»é™¤ä¸éœ€è¦çš„æƒé™

### 2. æƒé™åˆ†ç¦»
- ä¸åŒåŠŸèƒ½ä½¿ç”¨ä¸åŒçš„æœåŠ¡è´¦å·
- è¯»å†™æ“ä½œåˆ†ç¦»
- å¼€å‘å’Œç”Ÿäº§ç¯å¢ƒåˆ†ç¦»

### 3. ç›‘æ§å’Œå®¡è®¡
- è®°å½•æ‰€æœ‰APIè°ƒç”¨
- ç›‘æ§å¼‚å¸¸æƒé™ä½¿ç”¨
- å®šæœŸå®¡è®¡æƒé™é…ç½®

### 4. é”™è¯¯å¤„ç†
```python
def safe_delete_file(service, file_id):
    try:
        service.files().delete(fileId=file_id).execute()
        return True, "åˆ é™¤æˆåŠŸ"
    except HttpError as e:
        if e.resp.status == 403:
            return False, "æƒé™ä¸è¶³ï¼Œæ— æ³•åˆ é™¤æ–‡ä»¶"
        elif e.resp.status == 404:
            return False, "æ–‡ä»¶ä¸å­˜åœ¨"
        else:
            return False, f"åˆ é™¤å¤±è´¥: {e}"
```

## æ€»ç»“

1. **å½“å‰é…ç½®**ï¼šä½¿ç”¨æœ€å®½æ³›çš„æƒé™ï¼ŒåŠŸèƒ½å®Œæ•´ä½†å®‰å…¨æ€§è¾ƒä½
2. **å»ºè®®é…ç½®**ï¼šæ ¹æ®åŠŸèƒ½éœ€æ±‚åˆ†åˆ«é…ç½®ä¸åŒçº§åˆ«çš„æƒé™
3. **æƒé™é—®é¢˜**ï¼šä¸»è¦ç”±æ–‡ä»¶æ‰€æœ‰æƒå¼•èµ·ï¼Œéœ€è¦åˆç†çš„æƒé™é…ç½®å’Œé”™è¯¯å¤„ç†
4. **æœ€ä½³å®è·µ**ï¼šéµå¾ªæœ€å°æƒé™åŸåˆ™ï¼Œå®ç°æƒé™åˆ†ç¦»å’Œç›‘æ§

é€šè¿‡åˆç†é…ç½®æƒé™ï¼Œå¯ä»¥åœ¨ä¿è¯åŠŸèƒ½éœ€æ±‚çš„åŒæ—¶æœ€å¤§åŒ–ç³»ç»Ÿå®‰å…¨æ€§ã€‚