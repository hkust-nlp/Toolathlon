# OpenHands MCP é›†æˆå®Œæˆæ€»ç»“

## âœ… å®Œæˆçš„å·¥ä½œ

### 1. YAML é…ç½®è½¬æ¢å±‚
**æ–‡ä»¶**: `mcpbench_dev/utils/mcp/openhands_mcp_config.py` (~370 è¡Œ)

åˆ›å»ºäº†å®Œæ•´çš„ YAML åˆ° OpenHands é…ç½®è½¬æ¢å™¨ï¼š
- âœ… åŠ è½½ YAML é…ç½®æ–‡ä»¶
- âœ… å¤„ç†æ¨¡æ¿å˜é‡ï¼ˆ`${agent_workspace}`, `${token.*}`, `${config.*}`ï¼‰
- âœ… è½¬æ¢ä¸º OpenHands `mcpServers` Dict æ ¼å¼
- âœ… æ”¯æŒ stdio å’Œ sse ä¸¤ç§æœåŠ¡å™¨ç±»å‹
- âœ… ä¿ç•™ç‰¹æ®Šå¤„ç†é€»è¾‘ï¼ˆå¦‚ playwright çš„ `--no-sandbox`ï¼‰

**æµ‹è¯•ç»“æœ**: å…¨éƒ¨ 3 ä¸ªæµ‹è¯•é€šè¿‡ âœ…
- åŸºç¡€é…ç½®è½¬æ¢
- æ¨¡æ¿å˜é‡æ›¿æ¢
- åŠ è½½å…¨éƒ¨ 39 ä¸ªæœåŠ¡å™¨é…ç½®

### 2. TaskAgent MCP åˆå§‹åŒ–æ›¿æ¢
**æ–‡ä»¶**: `mcpbench_dev/utils/roles/task_agent.py`

**ä¿®æ”¹å†…å®¹**:

#### a) æ·»åŠ å¯¼å…¥ (ç¬¬ 29-45 è¡Œ)
```python
from utils.mcp.openhands_mcp_config import create_openhands_mcp_config
from openhands.sdk.mcp.utils import create_mcp_tools as openhands_create_mcp_tools
```

#### b) ä¿®æ”¹ `setup_mcp_servers()` æ–¹æ³• (ç¬¬ 418-473 è¡Œ)
**ä¹‹å‰**: ä½¿ç”¨ `MCPServerManager` åˆ›å»ºæŒä¹…è¿æ¥
```python
self.mcp_manager = MCPServerManager(...)
await self.mcp_manager.connect_servers(...)
```

**ä¹‹å**: ä½¿ç”¨ OpenHands SDK åˆ›å»ºå·¥å…·
```python
# 1. è½¬æ¢ YAML é…ç½®ä¸º OpenHands æ ¼å¼
self.openhands_mcp_config = create_openhands_mcp_config(
    agent_workspace=self.task_config.agent_workspace,
    config_dir=self.mcp_config.server_config_path,
    server_names=self.task_config.needed_mcp_servers,
    local_token_key_session=local_token_key_session,
    debug=self.debug
)

# 2. ä½¿ç”¨ OpenHands SDK åˆ›å»º MCP å·¥å…·ï¼ˆä¸´æ—¶è¿æ¥ï¼Œè·å–å·¥å…·åˆ—è¡¨åæ–­å¼€ï¼‰
self.mcp_tools = openhands_create_mcp_tools(
    config=self.openhands_mcp_config,
    timeout=30.0
)
```

#### c) ä¿®æ”¹ `setup_agent()` æ–¹æ³• (ç¬¬ 475-523 è¡Œ)
**ä¹‹å‰**: ä¼ é€’ `mcp_servers` å‚æ•°
```python
self.agent = Agent(
    ...
    mcp_servers=[*self.mcp_manager.get_all_connected_servers()],
    tools=local_tools,
    ...
)
```

**ä¹‹å**: åˆå¹¶ MCP å·¥å…·åˆ° tools å‚æ•°
```python
# åˆå¹¶æœ¬åœ°å·¥å…·å’Œ MCP å·¥å…·
all_tools = local_tools + self.mcp_tools

self.agent = Agent(
    ...
    mcp_servers=[],  # ä¸å†ä½¿ç”¨ï¼ŒMCP å·¥å…·å·²åœ¨ tools ä¸­
    tools=all_tools,  # åŒ…å«æœ¬åœ°å·¥å…· + OpenHands MCP å·¥å…·
    ...
)
```

#### d) ä¿®æ”¹ `cleanup()` æ–¹æ³• (ç¬¬ 952-963 è¡Œ)
**ä¹‹å‰**: æ‰‹åŠ¨æ–­å¼€ MCP æœåŠ¡å™¨
```python
if self.mcp_manager:
    await self.mcp_manager.disconnect_servers()
```

**ä¹‹å**: æ— éœ€æ‰‹åŠ¨æ¸…ç†ï¼ˆOpenHands è‡ªåŠ¨ç®¡ç†ï¼‰
```python
# OpenHands MCP å·¥å…·ä¼šè‡ªåŠ¨ç®¡ç†è¿æ¥ï¼Œæ— éœ€æ‰‹åŠ¨æ¸…ç†
pass
```

### 3. é›†æˆæµ‹è¯•
**æ–‡ä»¶**: `mcpbench_dev/test_openhands_integration.py`

**æµ‹è¯•ç»“æœ**: âœ… æˆåŠŸ
```
âœ… Successfully created 12 MCP tools!

Available tools:
  1. read_file
  2. read_multiple_files
  3. write_file
  4. edit_file
  5. create_directory
  6. list_directory
  7. list_directory_with_sizes
  8. directory_tree
  9. move_file
  10. search_files
  11. get_file_info
  12. list_allowed_directories

âœ… Tool call successful!
```

## ğŸ¯ æ ¸å¿ƒå˜åŒ–å¯¹æ¯”

### MCP è¿æ¥æ¨¡å¼
| æ–¹é¢ | ä¹‹å‰ (MCPServerManager) | ä¹‹å (OpenHands SDK) |
|------|------------------------|---------------------|
| **è¿æ¥æ–¹å¼** | æŒä¹…è¿æ¥ | æŒ‰éœ€è¿æ¥ |
| **åˆå§‹åŒ–** | `await manager.connect_servers()` | `create_mcp_tools(config)` |
| **å·¥å…·è°ƒç”¨** | ç›´æ¥è°ƒç”¨å·²è¿æ¥æœåŠ¡å™¨ | æ¯æ¬¡è°ƒç”¨è‡ªåŠ¨è¿æ¥/æ–­å¼€ |
| **æ¸…ç†** | æ‰‹åŠ¨ `disconnect_servers()` | è‡ªåŠ¨ç®¡ç† |
| **æ€§èƒ½** | æ›´å¿«ï¼ˆè¿æ¥å¤ç”¨ï¼‰ | ç¨æ…¢ï¼ˆæ¯æ¬¡é‡è¿ï¼‰ |
| **å¤æ‚åº¦** | é«˜ï¼ˆéœ€ç®¡ç†è¿æ¥çŠ¶æ€ï¼‰ | ä½ï¼ˆè‡ªåŠ¨ç®¡ç†ï¼‰ |

### é…ç½®ç³»ç»Ÿ
| æ–¹é¢ | ä¿ç•™ | å˜åŒ– |
|------|------|------|
| **YAML é…ç½®æ–‡ä»¶** | âœ… å®Œå…¨ä¿ç•™ | æ— å˜åŒ– |
| **æ¨¡æ¿å˜é‡** | âœ… å®Œå…¨ä¿ç•™ | æ— å˜åŒ– |
| **Token ä¼˜å…ˆçº§** | âœ… å®Œå…¨ä¿ç•™ | æ— å˜åŒ– |
| **åˆå§‹åŒ–é€»è¾‘** | âŒ æ›¿æ¢ | ä½¿ç”¨ OpenHands SDK |

## ğŸ“Š æ¶æ„æµç¨‹

### åˆå§‹åŒ–æµç¨‹
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  task_agent.setup_mcp_servers()              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
                  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  create_openhands_mcp_config()               â”‚
â”‚  â”œâ”€ åŠ è½½ YAML æ–‡ä»¶                            â”‚
â”‚  â”œâ”€ å¤„ç†æ¨¡æ¿å˜é‡                              â”‚
â”‚  â””â”€ è½¬æ¢ä¸º OpenHands Dict æ ¼å¼                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
                  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  OpenHands SDK: create_mcp_tools()           â”‚
â”‚  â”œâ”€ ä¸´æ—¶è¿æ¥ MCP æœåŠ¡å™¨                       â”‚
â”‚  â”œâ”€ è·å–å·¥å…·åˆ—è¡¨                              â”‚
â”‚  â”œâ”€ ä¸ºæ¯ä¸ªå·¥å…·åˆ›å»º MCPTool                     â”‚
â”‚  â””â”€ æ–­å¼€è¿æ¥                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
                  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  self.mcp_tools = [MCPTool, ...]            â”‚
â”‚  (å­˜å‚¨åœ¨ TaskAgent ä¸­)                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Agent åˆ›å»ºæµç¨‹
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  task_agent.setup_agent()                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
                  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ”¶é›†å·¥å…·                                     â”‚
â”‚  â”œâ”€ local_tools = [...]                     â”‚
â”‚  â””â”€ all_tools = local_tools + mcp_tools     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
                  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Agent(                                      â”‚
â”‚    tools=all_tools,    # åŒ…å« MCP å·¥å…·        â”‚
â”‚    mcp_servers=[],     # ç©ºï¼Œä¸å†ä½¿ç”¨          â”‚
â”‚    ...                                       â”‚
â”‚  )                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### å·¥å…·è°ƒç”¨æµç¨‹
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Agent è°ƒç”¨ MCP å·¥å…·                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
                  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  MCPTool.__call__(action)                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
                  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  MCPClient (OpenHands SDK)                  â”‚
â”‚  â”œâ”€ async with client: (è¿æ¥ MCP æœåŠ¡å™¨)      â”‚
â”‚  â”œâ”€ client.call_tool_mcp(...)               â”‚
â”‚  â””â”€ __aexit__ (æ–­å¼€è¿æ¥)                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
                  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  è¿”å› MCPToolObservation                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ”§ å…¼å®¹æ€§è¯´æ˜

### âœ… ä¿ç•™çš„åŠŸèƒ½
1. **æ‰€æœ‰ YAML é…ç½®** - æ— éœ€ä¿®æ”¹ä»»ä½•é…ç½®æ–‡ä»¶
2. **æ¨¡æ¿å˜é‡ç³»ç»Ÿ** - æ‰€æœ‰ `${}` å˜é‡æ­£å¸¸å·¥ä½œ
3. **Token ç®¡ç†** - task-specific token ä¼˜å…ˆçº§ä¿æŒä¸å˜
4. **ç‰¹æ®Šå¤„ç†é€»è¾‘** - playwright root æ£€æµ‹ç­‰ä¿ç•™

### âš ï¸ ä¸å†ä½¿ç”¨çš„ç»„ä»¶
1. **MCPServerManager** - ä¸å†è°ƒç”¨ï¼ˆä½†ä»£ç ä¿ç•™åœ¨ `utils/mcp/tool_servers.py`ï¼‰
2. **æŒä¹…è¿æ¥** - æ”¹ä¸ºæŒ‰éœ€è¿æ¥
3. **æ‰‹åŠ¨è¿æ¥ç®¡ç†** - ç”± OpenHands SDK è‡ªåŠ¨ç®¡ç†

### âš™ï¸ éœ€è¦çš„ä¾èµ–
ç¡®ä¿ OpenHands SDK åœ¨æ­£ç¡®è·¯å¾„ï¼š
```bash
# éœ€è¦ agent-sdk/ åœ¨é¡¹ç›®æ ¹ç›®å½•çš„ä¸Šä¸€çº§
/ssddata/mcpbench/wenshuo/scaffold/
â”œâ”€â”€ mcpbench_dev/          # å½“å‰é¡¹ç›®
â””â”€â”€ agent-sdk/             # OpenHands SDK
```

## ğŸ“ ä½¿ç”¨ç¤ºä¾‹

### åœ¨ TaskAgent ä¸­çš„ä½¿ç”¨
```python
# åˆ›å»º TaskAgent
task_agent = TaskAgent(
    task_config=task_config,
    agent_config=agent_config,
    ...
)

# åˆå§‹åŒ– MCP æœåŠ¡å™¨ï¼ˆä½¿ç”¨ OpenHandsï¼‰
await task_agent.setup_mcp_servers(local_token_key_session)

# åˆå§‹åŒ– Agentï¼ˆåˆå¹¶ MCP å·¥å…·ï¼‰
await task_agent.setup_agent()

# è¿è¡Œä»»åŠ¡ï¼ˆMCP å·¥å…·è‡ªåŠ¨æŒ‰éœ€è¿æ¥ï¼‰
await task_agent.run_interaction_loop(task_query)

# æ¸…ç†ï¼ˆæ— éœ€æ‰‹åŠ¨æ–­å¼€ MCPï¼‰
await task_agent.cleanup()
```

### é…ç½®ç¤ºä¾‹
**YAML é…ç½®** (configs/mcp_servers/filesystem.yaml):
```yaml
type: stdio
name: filesystem
params:
  command: npx
  args:
    - "-y"
    - "@modelcontextprotocol/server-filesystem"
    - "${agent_workspace}"  # æ¨¡æ¿å˜é‡
```

**è‡ªåŠ¨è½¬æ¢ä¸º** OpenHands æ ¼å¼:
```python
{
    "mcpServers": {
        "filesystem": {
            "command": "npx",
            "args": [
                "-y",
                "@modelcontextprotocol/server-filesystem",
                "/tasks/task001/workspace"  # å·²æ›¿æ¢
            ]
        }
    }
}
```

## ğŸ§ª æµ‹è¯•

### è¿è¡Œé…ç½®è½¬æ¢æµ‹è¯•
```bash
cd mcpbench_dev
uv run python test_openhands_mcp_config.py
```

### è¿è¡Œé›†æˆæµ‹è¯•
```bash
cd mcpbench_dev
uv run python test_openhands_integration.py
```

### é¢„æœŸè¾“å‡º
```
âœ… Successfully created 12 MCP tools!
âœ… Tool call successful!
ğŸ‰ OpenHands MCP Integration Test PASSED!
```

## ğŸ“š ç›¸å…³æ–‡ä»¶

### æ–°å¢æ–‡ä»¶
- `utils/mcp/openhands_mcp_config.py` - YAML åˆ° OpenHands é…ç½®è½¬æ¢å™¨
- `test_openhands_mcp_config.py` - é…ç½®è½¬æ¢æµ‹è¯•
- `test_openhands_integration.py` - é›†æˆæµ‹è¯•

### ä¿®æ”¹æ–‡ä»¶
- `utils/roles/task_agent.py` - MCP åˆå§‹åŒ–é€»è¾‘æ›¿æ¢
  - ç¬¬ 29-45 è¡Œ: æ·»åŠ å¯¼å…¥
  - ç¬¬ 418-473 è¡Œ: `setup_mcp_servers()` æ–¹æ³•
  - ç¬¬ 475-523 è¡Œ: `setup_agent()` æ–¹æ³•
  - ç¬¬ 952-963 è¡Œ: `cleanup()` æ–¹æ³•

### ä¿ç•™æ–‡ä»¶ï¼ˆæœªä¿®æ”¹ï¼‰
- `utils/mcp/tool_servers.py` - åŸ MCPServerManagerï¼ˆä¿ç•™å…¼å®¹ï¼‰
- `configs/mcp_servers/*.yaml` - æ‰€æœ‰ YAML é…ç½®
- `configs/token_key_session.py` - Token é…ç½®
- `configs/global_configs.py` - å…¨å±€é…ç½®

## ğŸ‰ å®ŒæˆçŠ¶æ€

- âœ… YAML é…ç½®è½¬æ¢å™¨åˆ›å»ºå¹¶æµ‹è¯•é€šè¿‡
- âœ… TaskAgent MCP åˆå§‹åŒ–æ›¿æ¢ä¸º OpenHands SDK
- âœ… é›†æˆæµ‹è¯•é€šè¿‡ï¼Œå·¥å…·è°ƒç”¨æ­£å¸¸
- âœ… ä¿æŒä¸åŸæœ‰é…ç½®ç³»ç»Ÿçš„å®Œå…¨å…¼å®¹
- âœ… æ–‡æ¡£å®Œæ•´

**MCP Server åˆå§‹åŒ–ç®¡ç†çš„ OpenHands é›†æˆå·²å®Œæˆï¼** ğŸš€

ä¸‹ä¸€æ­¥å¯ä»¥ç»§ç»­è¿›è¡Œ Agent Loop çš„æ›¿æ¢ï¼ˆä½¿ç”¨ OpenHands çš„ Conversation å’Œ Event ç³»ç»Ÿï¼‰ã€‚
